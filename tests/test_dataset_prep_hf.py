from unittest import TestCase
from datasets import load_dataset
import numpy as np
import json
import os
from collections import defaultdict
import torch
from torch.utils.data import DataLoader

from pathformer.datasets.path_dataset import (mapping_func, my_collate, causal_dataset_transform)

from pathformer.models.simple import PathTransformerModel

class TestDatasetBuilder(TestCase):

    @classmethod
    def setUpClass(cls):
        cls.data_example = [{'command': [[0], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [2]], 'coord': [[379.0, 1.0], [1.0, 6.0], [1.0, 8.0], [0.0, 6.0], [0.0, 6.0], [0.0, 5.0], [1.0, 0.0], [362.0, 17.0], [6.0, 0.0], [7.0, 0.0], [5.0, 0.0], [8.0, -1.0], [5.0, 0.0], [6.0, 0.0], [5.0, 0.0], [5.0, 2.0], [1.0, 5.0], [0.0, 6.0], [-5.0, 3.0], [-8.0, 0.0], [-5.0, 0.0], [-8.0, -3.0], [-7.0, -2.0], [-7.0, -2.0], [-7.0, -2.0], [-7.0, -2.0], [-8.0, -2.0], [-6.0, -2.0], [-6.0, -1.0], [-3.0, -2.0], [352.0, 22.0], [2.0, 5.0], [2.0, 5.0], [2.0, 6.0], [1.0, 6.0], [6.0, 2.0], [5.0, 0.0], [9.0, 0.0], [6.0, 0.0], [5.0, 0.0], [6.0, 0.0], [8.0, 0.0], [6.0, 0.0], [4.0, -5.0], [0.0, -6.0], [0.0, -4.0], [386.0, 20.0], [-1.0, 6.0], [0.0, 8.0], [4.0, 7.0], [0.0, 10.0], [0.0, 11.0], [0.0, 11.0], [0.0, 9.0], [0.0, 7.0], [0.0, 6.0], [0.0, 6.0], [0.0, 5.0], [2.0, 6.0], [0.0, 6.0], [1.0, 6.0], [1.0, 8.0], [0.0, 8.0], [0.0, 10.0], [-3.0, 11.0], [-2.0, 7.0], [-1.0, 5.0], [-2.0, 6.0], [0.0, 5.0], [0.0, 5.0], [-1.0, 5.0], [-1.0, 1.0], [263.0, 219.0], [6.0, 0.0], [11.0, 0.0], [10.0, 0.0], [12.0, 0.0], [16.0, 0.0], [31.0, 0.0], [34.0, 0.0], [38.0, 0.0], [48.0, 0.0], [52.0, 0.0], [56.0, 0.0], [58.0, 0.0], [69.0, 0.0], [66.0, 0.0], [61.0, 0.0], [61.0, 0.0], [58.0, 0.0], [59.0, 0.0], [61.0, 0.0], [50.0, 2.0], [42.0, 2.0], [37.0, 2.0], [31.0, 1.0], [26.0, 2.0], [23.0, 3.0], [21.0, 1.0], [17.0, 1.0], [14.0, 2.0], [14.0, 1.0], [13.0, 1.0], [7.0, 1.0], [0.0, 6.0], [0.0, 7.0], [0.0, 5.0], [0.0, 5.0], [-1.0, 6.0], [-1.0, 5.0], [0.0, 5.0], [-1.0, 6.0], [-1.0, 7.0], [0.0, 10.0], [0.0, 5.0], [0.0, 7.0], [0.0, 6.0], [-1.0, 5.0], [0.0, 5.0], [0.0, 5.0], [0.0, 6.0], [-1.0, 7.0], [-1.0, 5.0], [-2.0, 7.0], [-5.0, 6.0], [-7.0, 4.0], [-10.0, 4.0], [-8.0, 2.0], [-11.0, 3.0], [-11.0, 2.0], [-12.0, 1.0], [-14.0, 1.0], [-15.0, 1.0], [-15.0, 1.0], [-17.0, 2.0], [-23.0, 1.0], [-23.0, 1.0], [-20.0, 2.0], [-20.0, 1.0], [-21.0, 2.0], [-20.0, 1.0], [-20.0, 1.0], [-23.0, 2.0], [-23.0, 0.0], [-20.0, 0.0], [-19.0, 0.0], [-23.0, 0.0], [-19.0, 0.0], [-20.0, 0.0], [-17.0, 0.0], [-17.0, 0.0], [-17.0, 0.0], [-16.0, 0.0], [-17.0, 0.0], [-18.0, -1.0], [-29.0, -3.0], [-26.0, -3.0], [-26.0, -1.0], [-23.0, -2.0], [-21.0, -1.0], [-17.0, 0.0], [-19.0, 0.0], [-25.0, 0.0], [-25.0, 0.0], [-26.0, 0.0], [-22.0, 0.0], [-20.0, -2.0], [-20.0, 0.0], [-20.0, -1.0], [-15.0, 0.0], [-14.0, 0.0], [-12.0, 0.0], [-11.0, 0.0], [-11.0, -1.0], [-11.0, -1.0], [-12.0, -2.0], [-11.0, -3.0], [-13.0, -3.0], [-11.0, -3.0], [-13.0, -4.0], [-11.0, -3.0], [-10.0, -3.0], [-9.0, -3.0], [-9.0, -2.0], [-7.0, -1.0], [-7.0, -2.0], [-7.0, -1.0], [-9.0, -1.0], [-7.0, -2.0], [-8.0, -2.0], [-6.0, -2.0], [-5.0, -2.0], [-7.0, -3.0], [-5.0, -5.0], [-2.0, -6.0], [0.0, -6.0], [0.0, -5.0], [0.0, -5.0], [0.0, -6.0], [0.0, -6.0], [-1.0, -6.0], [-2.0, -8.0], [-3.0, -8.0], [-4.0, -7.0], [-3.0, -6.0], [-3.0, -5.0], [-4.0, -7.0], [-3.0, -5.0], [-3.0, -5.0], [-2.0, -5.0], [-2.0, -5.0], [-1.0, -1.0], [397.0, 374.0], [0.0, 5.0], [0.0, 6.0], [0.0, 5.0], [0.0, 6.0], [-1.0, 5.0], [8.0, 4.0], [6.0, 1.0], [10.0, 1.0], [10.0, 1.0], [10.0, 0.0], [11.0, 1.0], [13.0, 0.0], [13.0, 0.0], [17.0, 1.0], [15.0, 0.0], [14.0, 0.0], [13.0, 0.0], [12.0, 0.0], [12.0, 0.0], [10.0, 0.0], [10.0, 0.0], [6.0, 0.0], [6.0, 0.0], [5.0, 0.0], [6.0, -1.0], [6.0, 1.0], [8.0, 1.0], [6.0, 1.0], [6.0, 0.0], [8.0, 1.0], [7.0, 0.0], [5.0, 0.0], [7.0, 0.0], [6.0, 0.0], [7.0, 0.0], [8.0, 0.0], [8.0, 0.0], [7.0, 0.0], [7.0, 0.0], [7.0, 0.0], [5.0, 0.0], [5.0, 0.0], [6.0, 1.0], [7.0, 2.0], [8.0, 1.0], [10.0, 2.0], [6.0, 0.0], [7.0, 1.0], [7.0, 1.0], [7.0, 1.0], [6.0, 1.0], [5.0, 0.0], [7.0, 0.0], [5.0, 0.0], [1.0, -5.0], [1.0, -5.0], [0.0, -6.0], [0.0, -5.0], [0.0, -3.0], [394.0, 155.0], [6.0, 0.0], [5.0, 0.0], [9.0, -1.0], [12.0, 0.0], [12.0, 0.0], [14.0, 0.0], [16.0, 0.0], [17.0, 0.0], [17.0, 0.0], [22.0, 0.0], [18.0, 1.0], [12.0, 2.0], [10.0, 2.0], [9.0, 2.0], [7.0, 2.0], [5.0, 3.0], [5.0, 4.0], [3.0, 5.0], [1.0, 5.0], [0.0, 5.0], [-2.0, 5.0], [-4.0, 5.0], [-3.0, 5.0], [-2.0, 5.0], [-2.0, 4.0], [477.0, 151.0], [-4.0, -5.0], [-2.0, -7.0], [-2.0, -8.0], [-1.0, -6.0], [-2.0, -6.0], [-2.0, -6.0], [-2.0, -6.0], [-1.0, -5.0], [8.0, -3.0], [6.0, -1.0], [8.0, 0.0], [8.0, 0.0], [8.0, 0.0], [11.0, 0.0], [11.0, 0.0], [10.0, 0.0], [9.0, 0.0], [8.0, 0.0], [10.0, 0.0], [8.0, 0.0], [10.0, 2.0], [7.0, 2.0], [7.0, 2.0], [5.0, 1.0], [3.0, 5.0], [-1.0, 5.0], [-1.0, 6.0], [-2.0, 5.0], [-2.0, 5.0], [-2.0, 6.0], [-1.0, 5.0], [-1.0, 6.0], [-2.0, 2.0], [0.0, 0.0]]}, {'command': [[0], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [1], [0], [2]], 'coord': [[541.0, 326.8999938964844], [0.0, -1.0], [541.0, 325.8999938964844], [7.0, 0.0], [7.0, 0.0], [8.0, 1.0], [9.0, 3.0], [11.0, 3.0], [9.0, 2.0], [11.0, 2.0], [7.0, 1.0], [5.0, 0.0], [5.0, 1.0], [6.0, 0.0], [8.0, 0.0], [8.0, 1.0], [10.0, 2.0], [9.0, 0.0], [9.0, 0.0], [5.0, 0.0], [5.0, 0.0], [5.0, 1.0], [5.0, 0.0], [6.0, 1.0], [6.0, 1.0], [7.0, 0.0], [5.0, 0.0], [6.0, 0.0], [8.0, 0.0], [11.0, 0.0], [9.0, 0.0], [12.0, 0.0], [15.0, 0.0], [12.0, 0.0], [10.0, 2.0], [11.0, 0.0], [7.0, 0.0], [5.0, 0.0], [5.0, 0.0], [5.0, 0.0], [7.0, 0.0], [7.0, 0.0], [7.0, 0.0], [10.0, 0.0], [8.0, 0.0], [5.0, 0.0], [5.0, 0.0], [8.0, 0.0], [7.0, 0.0], [5.0, 0.0], [5.0, 0.0], [7.0, 0.0], [7.0, 0.0], [8.0, 0.0], [5.0, 0.0], [5.0, 0.0], [5.0, 0.0], [5.0, 5.0], [3.0, 6.0], [0.0, 5.0], [2.0, 5.0], [0.0, 5.0], [1.0, 6.0], [1.0, 5.0], [1.0, 5.0], [0.0, 5.0], [2.0, 5.0], [0.0, 5.0], [0.0, 5.0], [0.0, 5.0], [0.0, 6.0], [-3.0, 5.0], [-3.0, 5.0], [-3.0, 6.0], [-4.0, 5.0], [-5.0, 4.0], [-9.0, 7.0], [-5.0, 2.0], [-8.0, 4.0], [-5.0, 4.0], [-5.0, 4.0], [-5.0, 3.0], [-6.0, 3.0], [-5.0, 3.0], [-6.0, 3.0], [-5.0, 2.0], [-5.0, 3.0], [-6.0, 2.0], [-5.0, 1.0], [-6.0, 0.0], [-9.0, 0.0], [-7.0, 0.0], [-11.0, 0.0], [-5.0, 0.0], [-8.0, -1.0], [-5.0, 0.0], [-6.0, -1.0], [-8.0, -1.0], [-10.0, 0.0], [-6.0, -2.0], [-5.0, 0.0], [-6.0, 0.0], [-10.0, -2.0], [-8.0, 0.0], [-7.0, -2.0], [-8.0, -1.0], [-7.0, -1.0], [-6.0, 0.0], [-7.0, 0.0], [-7.0, 0.0], [-5.0, 0.0], [-6.0, 0.0], [-6.0, 0.0], [-6.0, 0.0], [-6.0, 0.0], [-8.0, 0.0], [-10.0, 0.0], [-9.0, 0.0], [-13.0, 0.0], [-15.0, 0.0], [-13.0, 0.0], [-12.0, 0.0], [-15.0, 0.0], [-11.0, 0.0], [-7.0, 0.0], [-7.0, -1.0], [-5.0, -2.0], [-11.0, -4.0], [-10.0, -2.0], [-10.0, -4.0], [-7.0, -2.0], [-10.0, -3.0], [-10.0, -2.0], [-7.0, -4.0], [-9.0, -1.0], [-6.0, 0.0], [-5.0, -2.0], [-5.0, -1.0], [-5.0, -1.0], [-5.0, -2.0], [-4.0, -6.0], [-1.0, -7.0], [-1.0, -5.0], [-1.0, -5.0], [-2.0, -5.0], [-5.0, -5.0], [-1.0, -7.0], [-1.0, -6.0], [-2.0, -5.0], [0.0, -6.0], [0.0, -5.0], [0.0, -6.0], [0.0, -6.0], [0.0, -6.0], [0.0, -7.0], [0.0, -7.0], [1.0, -5.0], [6.0, -6.0], [7.0, -3.0], [3.0, -5.0], [6.0, -3.0], [6.0, -2.0], [10.0, -3.0], [14.0, -4.0], [15.0, -3.0], [23.0, -2.0], [17.0, -3.0], [11.0, -1.0], [6.0, 4.0], [8.0, 8.0], [6.0, 4.0], [6.0, 4.0], [2.0, 2.0], [557.0, 258.8999938964844], [5.0, -1.0], [8.0, 2.0], [8.0, 1.0], [5.0, 1.0], [6.0, 3.0], [5.0, 1.0], [7.0, 0.0], [8.0, 0.0], [7.0, 0.0], [6.0, 1.0], [8.0, 2.0], [7.0, 0.0], [6.0, 0.0], [6.0, 0.0], [12.0, 0.0], [11.0, 0.0], [5.0, 0.0], [7.0, 0.0], [6.0, 0.0], [7.0, 0.0], [5.0, 0.0], [9.0, 0.0], [10.0, 0.0], [5.0, 0.0], [11.0, 0.0], [5.0, 0.0], [5.0, 0.0], [8.0, 0.0], [8.0, 0.0], [7.0, 0.0], [7.0, 0.0], [5.0, 0.0], [7.0, 0.0], [5.0, 0.0], [8.0, 0.0], [8.0, 0.0], [7.0, 1.0], [6.0, 0.0], [5.0, 0.0], [5.0, 1.0], [6.0, 2.0], [6.0, 1.0], [7.0, 0.0], [9.0, 1.0], [6.0, 2.0], [5.0, 1.0], [5.0, 3.0], [5.0, 1.0], [5.0, 2.0], [1.0, 5.0], [0.0, 5.0], [0.0, 6.0], [0.0, 5.0], [-1.0, 5.0], [-2.0, 5.0], [-2.0, 5.0], [-4.0, 6.0], [-3.0, 5.0], [-5.0, 4.0], [-5.0, 1.0], [-6.0, 0.0], [-6.0, 0.0], [-8.0, 0.0], [-6.0, 0.0], [-7.0, 0.0], [-7.0, 0.0], [-5.0, 2.0], [-6.0, 0.0], [-10.0, 3.0], [-5.0, 0.0], [-10.0, 1.0], [-6.0, 2.0], [-8.0, 0.0], [-6.0, 0.0], [-8.0, 0.0], [-5.0, 0.0], [-6.0, -1.0], [-5.0, 0.0], [-9.0, -1.0], [-10.0, 0.0], [-5.0, 0.0], [-5.0, -2.0], [-7.0, 0.0], [-7.0, 0.0], [-7.0, 0.0], [-6.0, -1.0], [-7.0, -1.0], [-5.0, -2.0], [-7.0, -2.0], [-6.0, -2.0], [-8.0, -2.0], [-8.0, -3.0], [-9.0, -2.0], [-7.0, -1.0], [-7.0, -5.0], [-5.0, 0.0], [-5.0, -3.0], [-5.0, -1.0], [-6.0, -2.0], [-6.0, -2.0], [-7.0, -1.0], [-6.0, -1.0], [-5.0, -1.0], [-5.0, 0.0], [-6.0, -1.0], [-7.0, -2.0], [-5.0, -3.0], [-2.0, -5.0], [-1.0, -5.0], [0.0, -5.0], [0.0, -5.0], [0.0, -7.0], [0.0, -6.0], [0.0, -5.0], [1.0, -5.0], [0.0, -5.0], [1.0, -5.0], [0.0, -2.0], [707.0, 289.8999938964844], [0.0, 5.0], [-1.0, 5.0], [-2.0, 5.0], [-2.0, 6.0], [-2.0, 6.0], [0.0, 6.0], [1.0, 6.0], [5.0, 3.0], [5.0, -1.0], [5.0, -2.0], [4.0, -5.0], [2.0, -5.0], [1.0, -5.0], [0.0, -5.0], [2.0, -5.0], [1.0, -5.0], [1.0, -7.0], [0.0, -5.0], [0.0, 0.0], [637.0, 267.8999938964844], [-2.0, -5.0], [-1.0, -6.0], [-1.0, -5.0], [-2.0, -5.0], [-2.0, -5.0], [-3.0, -6.0], [-3.0, -5.0], [-4.0, -5.0], [-3.0, -6.0], [-4.0, -6.0], [-2.0, -6.0], [-5.0, -8.0], [-4.0, -5.0], [-3.0, -5.0], [0.0, 0.0], [593.0, 181.89999389648438], [0.0, 0.0]]}]

    def test_mapping_func(self):
        dataset = load_dataset('quickdraw', "raw", split='train')
        proc_dataset = (dataset.select(range(10000)).
                        with_transform(mapping_func, columns=["drawing", "word"]))
        self.assertIsNotNone(proc_dataset[0])

    def test_dataloader_tf(self):
        rez = my_collate(self.data_example)
        print(f"==> {rez["command"].shape}")

    def test_label_creation(self):
        rez = list(causal_dataset_transform(self.data_example))
        self.assertEqual(len(rez), len(self.data_example[0]["command"]) + len(self.data_example[1]["command"]) - 2, rez)
        self.assertEqual(len(rez[0].keys()), 4)

    def test_full_dataloader_tf(self):
        dataset = load_dataset('quickdraw', "raw", split='train')
        sub_dataset = ((dataset.select(range(10000)).
                       with_transform(mapping_func, columns=["drawing", "word"])))
        dataloader = DataLoader(sub_dataset, batch_size=32, num_workers=1, collate_fn=my_collate, shuffle=True)
        batch = next(iter(dataloader))
        for k in ["command", "coord", "coord_target"]:
            self.assertEqual(batch[k].shape[0], 32)


